@inherits Custom.Hybrid.RazorTyped
@using ToSic.Razor.Blade;
@{
  // Check for Recursions, to prevent infinite loops!
  var recursions = MyModel.Int("Recursions", required: false, fallback: 0) + 1;
  if (recursions > 5) {
    throw new Exception("Recursion limit reached");
  }
}
@{
  var accordion = MyModel.Code("Accordion", required: false)
    ?? GetCode("./Accordion.cs").Setup(MyModel.Code("Sys"), MyModel.String("Variant", required: false));
  var tutPage = MyModel.Item("TutorialGroup", required: false) 
    ?? AsItems(App.Data["TutorialGroup"]).FirstOrDefault(i => i.String("NameId") == MyModel.String("NameId"));
}

@if (tutPage != null) {
  <div @Kit.Toolbar.Default(tutPage)>
    <h1>@Html.Raw(tutPage.String("Title", fallback: "no title", scrubHtml: "p"))</h1>
    @tutPage.Html("Intro")
    @tutPage.Html("IntroMore" + (accordion.IsTyped ? "Typed" : "Dyn"))
    @if (tutPage.IsNotEmpty("Note")) {
      <div class="alert alert-warning">
        @tutPage.Html("Note")
      </div>
    }
    @* Show all the 'shared' notes *@
    @Html.Partial("./Notes.cshtml", new { Item = tutPage })
  </div>
  

  if (tutPage.IsNotEmpty("Accordions")) {
    var accords = tutPage.Children("Accordions");

    // Check if any of the tutorials has variants - if yes, show the variant selector
    var showVariantSelector = accords.FirstOrDefault(a => a.Bool("HasVariants"));
    if (showVariantSelector != null) {
      @Html.Partial("./Variant Selector.cshtml", new { Current = accordion.Variant, Variants = showVariantSelector.String("Variants") })
    }


    foreach (var accSpecs in accords) {
      @Html.Partial("./Accordion One.cshtml", new { accordion, AccordionSpecs = accSpecs, skipPageTools = true, recursions })
    }
  } else {
    <text>
      Accordion list is empty.
      Use Toolbar to edit
    </text>
  }
}
else if (MyUser.IsSystemAdmin) {
  <div class="alert alert-danger" @Kit.Toolbar.Empty().New("TutorialGroup", prefill: new {
    NameId = MyModel.String("NameId")
  })>
    The Accordion LIST <strong>@MyModel.String("NameId")</strong> was not found.
    <br />
    This is something you probably want to create next.
    Use the Toolbar to create.
  </div>
}

<p>&nbsp;</p>